# Tripzy Backend

Бэкенд платформы Tripzy - система для управления сетями магазинов, продуктами и путешествиями.

## Описание проекта

Tripzy - это платформа, которая объединяет:
- **Клиентов (организации)** - сети магазинов, рестораны, кофейни
- **Пользователей** - туристов, администраторов организаций, администраторов магазинов
- **Магазины** - точки продаж с географическими координатами
- **Продукты** - товары и услуги с изображениями, атрибутами и категориями
- **Путешествия (Trips)** - маршруты пользователей с привязкой к магазинам

## Основные возможности

### Для клиентов (организаций)
- Регистрация организации и получение API-ключа
- Создание пользователей с ролями (администраторы организации и магазинов)
- Массовая загрузка магазинов с геолокацией и расписанием
- Управление продуктами, их атрибутами и изображениями
- Назначение администраторов магазинов

### Для пользователей (туристов)
- Регистрация и авторизация с JWT токенами
- Просмотр магазинов на карте с фильтрацией
- Поиск продуктов по категориям, магазинам и параметрам
- Добавление продуктов в избранное
- Создание и управление путешествиями
- Получение персонализированных рекомендаций

### Для администраторов
- **Администраторы организаций** - полный доступ ко всем данным клиента
- **Администраторы магазинов** - управление своими магазинами и продуктами

## Технологический стек

- **Runtime**: Node.js + TypeScript
- **Web Framework**: Fastify (высокопроизводительный HTTP-сервер)
- **База данных**: PostgreSQL
- **ORM**: Sequelize (с миграциями)
- **Аутентификация**: JWT токены
- **Хранилище файлов**: AWS S3 (для изображений продуктов)
- **Валидация**: JSON Schema

## Архитектура

Проект построен по модульной архитектуре с разделением на слои:

### Структура директорий
- **infrastructure/** - инфраструктурный слой (БД, конфигурация, логирование)
- **shared/** - общие утилиты (JWT, хеширование паролей, email)
- **lib/** - внутренние библиотеки проекта
- **app/** - бизнес-логика, организованная по сущностям

### Каждая сущность включает
- **handlers/** - HTTP обработчики (контроллеры с бизнес-логикой)
- **repositories/** - универсальные функции для работы с БД
- **schemas/** - JSON схемы для валидации запросов/ответов
- **models/** - модели данных Sequelize
- **services/** - вспомогательные утилиты для сущности

### Поток данных
HTTP Request → Handler → Repository → База данных

## API

Платформа предоставляет два типа API:

### 1. Public API (для туристов)
- **POST** `/api/auth/v1/registration` - регистрация пользователя
- **POST** `/api/auth/v1/login` - авторизация
- **GET** `/api/users/v1/:guid` - получение профиля пользователя
- **PATCH** `/api/users/v1/:guid` - обновление профиля
- **GET** `/api/shops/v1` - список магазинов с фильтрацией
- **GET** `/api/products/v1` - список продуктов с поиском
- **GET** `/api/favorites/v1` - избранные продукты
- **POST** `/api/favorites/v1` - добавить в избранное
- **GET** `/api/trips/v1` - список путешествий
- **POST** `/api/trips/v1` - создать путешествие

### 2. Client API (для организаций)
Требует API-ключ в заголовке `X-API-Key`

- **POST** `/api/clients/v1/register` - регистрация клиента
- **POST** `/api/clients/v1/users` - создание пользователя организации
- **POST** `/api/clients/v1/shops` - массовая загрузка магазинов
- **POST** `/api/clients/v1/products` - массовая загрузка продуктов
- **POST** `/api/clients/v1/productAttributes` - атрибуты продуктов
- **POST** `/api/clients/v1/products/:guid/images` - загрузка изображений
- **POST** `/api/clients/v1/shopAdministrators` - назначение администраторов

Подробная документация: [.docs/apiUsageForClients.md](.docs/apiUsageForClients.md)

## Роли пользователей

1. **Tourist (Турист)** - обычный пользователь платформы
   - Просмотр магазинов и продуктов
   - Управление избранным
   - Создание путешествий

2. **Client Admin (Администратор организации)** - управляет всей организацией
   - Создание магазинов
   - Управление продуктами во всех магазинах
   - Назначение администраторов магазинов

3. **Shop Admin (Администратор магазина)** - управляет конкретным магазином
   - Управление продуктами своего магазина
   - Просмотр статистики

## Безопасность

- **Аутентификация**: JWT токены с истечением через 24 часа
- **API-ключи**: Уникальные ключи для каждой организации
- **Хеширование паролей**: Bcrypt с солью
- **Валидация**: Все входящие данные проверяются JSON Schema
- **SQL Injection**: Защита через параметризованные запросы Sequelize
- **Авторизация**: Проверка ролей и принадлежности к организации

## База данных

### Основные таблицы
- **clients** - организации (сети магазинов)
- **users** - пользователи системы
- **user_roles** - роли (глобальные и привязанные к клиентам)
- **user_role_assignments** - связь пользователей и ролей
- **shops** - магазины с геолокацией
- **shop_administrators** - связь администраторов и магазинов
- **products** - продукты с ценами и категориями
- **product_attributes** - атрибуты продуктов (размер, цвет и т.д.)
- **product_attachments** - изображения продуктов в S3
- **favorites** - избранные продукты пользователей
- **trips** - путешествия пользователей
- **user_trips_assignments** - связь пользователей и путешествий

### Миграции
Все изменения схемы БД управляются через миграции Sequelize в директории `src/infrastructure/db/migrations/`

## Установка и запуск

### Требования
- Node.js 16+
- PostgreSQL 13+
- AWS S3 (или совместимое хранилище)
- Docker и Docker Compose (для запуска в контейнерах)

### Быстрый старт с Docker

Для запуска проекта в Docker-контейнерах смотрите подробную инструкцию:
**[DOCKER_SETUP.md](DOCKER_SETUP.md)** - руководство по развертыванию в Docker

### Переменные окружения
Создайте файл `.env` на основе примера и заполните:
- `DATABASE_URL` - строка подключения к PostgreSQL
- `JWT_SECRET` - секретный ключ для JWT
- `AWS_S3_*` - настройки S3 для хранения изображений
- `PORT` - порт сервера (по умолчанию 3000)

### Команды

**Разработка:**
- `npm run dev` - запуск с автоперезагрузкой (nodemon)
- `npm run build` - компиляция TypeScript
- `npm start` - запуск из скомпилированного dist/

**База данных:**
- `npm run db:build` - создание базы данных
- `npm run db:migrate` - применение миграций

**Качество кода:**
- `npm run lint` - проверка ESLint
- `npm run lint:fix` - автоисправление

## Основные принципы разработки

1. **Разделение ответственности** - каждый слой делает своё
2. **Универсальные repository** - функции с фильтрами вместо специфичных
3. **Path aliases** - `#Infrastructure/*` вместо относительных путей
4. **Типобезопасность** - строгий TypeScript mode
5. **Транзакции** - для множественных операций с БД
6. **Валидация** - на входе через JSON Schema
7. **Ошибки** - кастомные классы ошибок с понятными сообщениями

## Производительность

- **Fastify** - один из самых быстрых Node.js фреймворков
- **Массовые операции** - bulkCreate для загрузки множества записей
- **Индексы БД** - на часто используемых полях
- **Пагинация** - для списков (limit/offset)
- **S3 для файлов** - разгрузка основного сервера

## Документация

- [.docs/apiUsageForClients.md](.docs/apiUsageForClients.md) - руководство по Client API
- [.docs/LINTING.md](.docs/LINTING.md) - правила линтинга
- [DOCKER_SETUP.md](DOCKER_SETUP.md) - инструкция по запуску в Docker

## Roadmap

- [ ] Websockets для реального времени
- [ ] Уведомления пользователей
- [ ] Аналитика и статистика для клиентов
- [ ] Система отзывов и рейтингов
- [ ] Мобильное приложение

